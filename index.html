<script>
  let dadosHora = [];
  let dadosSalario = [];

  async function carregarDados() {
    try {
      const resposta = await fetch('https://script.google.com/macros/s/AKfycbyKMWfYsfbXfOw0MRS_Wh39jnjmdO7dJuCLPTb7hZT7K_DPoN8oSdDxFEiPGrcBx49yEw/exec');
      const apiDados = await resposta.json();

      // Tabela Hora Aula → Página109 colunas A, B, C
      dadosHora = apiDados.map(d => ({
        segmento: d.colA,
        unidade: d.colB,
        valor: parseFloat(d.colC) || 0
      })).filter(d => d.unidade);

      // Tabela Salário → Página109 colunas E, F, G
      dadosSalario = apiDados.map(d => ({
        segmento: d.colE,
        unidade: d.colF,
        salario: parseFloat(d.colG) || 0
      })).filter(d => d.unidade);

      // Preenche select com unidades de colB (Valor Hora)
      const unidades = [...new Set(dadosHora.map(d => d.unidade))];
      const select = document.getElementById("unidade");
      select.innerHTML = '<option value="">Selecione</option>';
      unidades.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u;
        opt.textContent = u;
        select.appendChild(opt);
      });

    } catch (erro) {
      console.error("Erro ao carregar dados da API:", erro);
      document.getElementById("unidade").innerHTML = '<option value="">Erro ao carregar</option>';
    }
  }

  function atualizarTabela() {
    const unidadeSelecionada = document.getElementById("unidade").value;
    const tabela = document.getElementById("tabela");
    tabela.innerHTML = "";
    if (!unidadeSelecionada) return;

    // Filtra Hora Aula por unidade (colB)
    const linhas = dadosHora.filter(d => d.unidade === unidadeSelecionada);
    linhas.forEach((d, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.segmento}</td>
        <td data-valor="${d.valor}">R$ ${d.valor.toFixed(2).replace('.', ',')}</td>
        <td><input type="number" class="qtd" id="qtd_${i}" min="0" value="0"></td>
        <td id="total_${i}">R$ 0,00</td>
      `;
      tabela.appendChild(tr);
    });

    document.querySelectorAll(".qtd").forEach((input, i) => {
      input.addEventListener("input", () => calcular(linhas));
    });

    calcular(linhas);
  }

  function atualizarTabelaSalario() {
    const unidadeSelecionada = document.getElementById("unidade").value;
    const tabelaSalario = document.getElementById("tabelaSalario");
    tabelaSalario.innerHTML = "";
    if (!unidadeSelecionada) return;

    // Filtra Salário por unidade (colF), mas unidade vem do select (colB)
    const linhas = dadosSalario.filter(d => d.unidade === unidadeSelecionada);
    linhas.forEach(d => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.segmento}</td>
        <td>R$ ${d.salario.toFixed(2).replace('.', ',')}</td>
      `;
      tabelaSalario.appendChild(tr);
    });
  }

  function calcular(linhas) {
    let soma = 0;
    linhas.forEach((d, i) => {
      const qtd = parseFloat(document.getElementById(`qtd_${i}`).value || 0);
      const total = d.valor * qtd;
      document.getElementById(`total_${i}`).innerText = "R$ " + total.toFixed(2).replace('.', ',');
      soma += total;
    });

    const unidade = document.getElementById("unidade").value;
    let fator = 1.05;
    if (unidade === "CSB" || unidade === "LOU") fator = 1.2;

    const totalGeral = ((soma * 4.5) * fator) + (((soma * 4.5) * fator) / 6);
    document.getElementById("totalGeral").innerText = "Total Geral: R$ " + totalGeral.toFixed(2).replace('.', ',');
  }

  // Carrega dados ao iniciar
  carregarDados();
</script>
